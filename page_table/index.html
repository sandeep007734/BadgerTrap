


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-5.1.7">
    
    
      
        <title>Page Table - ModBadgerTrap</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.4c7052ca.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../assets/mycss.css">
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#page-table" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="ModBadgerTrap" class="md-header-nav__button md-logo" aria-label="ModBadgerTrap">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            ModBadgerTrap
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Page Table
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="ModBadgerTrap" class="md-nav__button md-logo" aria-label="ModBadgerTrap">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    ModBadgerTrap
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Literature
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Literature" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Literature
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Page Table
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="Page Table" class="md-nav__link md-nav__link--active">
      Page Table
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#page-table" class="md-nav__link">
    Page table
  </a>
  
    <nav class="md-nav" aria-label="Page table">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#requirement" class="md-nav__link">
    Requirement
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#page-table_1" class="md-nav__link">
    Page table
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tlb" class="md-nav__link">
    TLB
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#huge-page" class="md-nav__link">
    Huge page
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      BadgerTrap
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="BadgerTrap" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        BadgerTrap
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../badgertrap/badgertrap/" title="Badger Trap" class="md-nav__link">
      Badger Trap
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../badgertrap/badgertrapinit/" title="Badger Init" class="md-nav__link">
      Badger Init
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Experiments
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Experiments" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Experiments
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../badgertrap/kernel/" title="Building Kernel" class="md-nav__link">
      Building Kernel
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#page-table" class="md-nav__link">
    Page table
  </a>
  
    <nav class="md-nav" aria-label="Page table">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#requirement" class="md-nav__link">
    Requirement
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#page-table_1" class="md-nav__link">
    Page table
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tlb" class="md-nav__link">
    TLB
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#huge-page" class="md-nav__link">
    Huge page
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  
                
                
                  <h1>Page Table</h1>
                
                <h3 id="page-table">Page table<a class="headerlink" href="#page-table" title="Permanent link">#</a></h3>
<p>In this post, we understand the working of a page table in the Linux kernel. As we understand, the memory management is one of the most crucial component of the kernel management. Any change in this has to go through rigorous testing and validation.</p>
<p>Understanding the memory architecture will help us gain an insight into the kerne workings.</p>
<h4 id="requirement">Requirement<a class="headerlink" href="#requirement" title="Permanent link">#</a></h4>
<p><img alt="large_drawing" src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/32/Virtual_address_space_and_physical_address_space_relationship.svg/880px-Virtual_address_space_and_physical_address_space_relationship.svg.png" />
<strong>Virtual to physical address mapping. Source: Wikipedia</strong></p>
<p>There are multiple purposes of a page table:  </p>
<ul>
<li>Program isolation <br />
    The application does not have to worry about corrupting another application's memory space, willingly or un-willingly. The OS will ensure that any such access will result into a segmentation fault, otherwise know as <code>SEGSEV</code> fault.</li>
<li>Security<br />
    By ensuring that an another processing cannot snoop into my memory, the OS guarantees that the the content of my memory is protected. Please note that the OS here is a trusted entity as it has access to memory areas of all the programs. </li>
</ul>
<div class="admonition todo">
<p class="admonition-title">Todo<p>How does a program like CheatEngine works then?</p>
</p>
</div>
<ul>
<li>Increase working set size<br />
    Virtual memory also allows us to execute an application that requires more memory than currently present in the system. In this case, the OS will use the <em>swap</em> space to move-out and move-in memory pages as and when required. This is a very neat trick and is completely transparent to the applications. This will add some performance overhead due to swapping, which is typically stored in a slower storage medium, such as HDD or more recently SSD.</li>
</ul>
<h4 id="page-table_1">Page table<a class="headerlink" href="#page-table_1" title="Permanent link">#</a></h4>
<p><img alt="image" src="/images/4-level-page-table.png" />
<strong>Address translation for a 32 bit address in an X86 system using 4 level page table. Source: AMD 64 bit Programmers Manual 2 Chapter 5</strong></p>
<p>As can be seen the figure above, </p>
<ol>
<li>As can be seen in the figure above, the first 9 bits are used to offset into the <em>page map table</em>. The base of the table is obtained from the <code>CR3</code> register. This is a new addition to page table hierarchy since the page table moved from the 3-level to 4-level structure to support more memory in the 64-bit systems.</li>
<li>Each entry in the <em>page map table</em> points to a page directory pointer table, also know as <em>page global directory</em> or pgd. This was first level in the 3-level page table, hence, the term <em>global</em>. The next 9 bits are used to offset into the PGD.</li>
<li>Each PGD points to a page directory table also known as <em>page middle directory PMD</em>. Each entry in tha PMD points to a page table. The next 9 bits are used to offset into the page table.</li>
<li>The page table is the last level of in-direction. Each entry in tha page table points to a page. The next 9 bits are used to offset into the page table.</li>
<li>From the page table, we get the base address of a page. This is the granularity at which the page table operates. The last 12 bits are used to offset into the page table at byte-level address, at which the DRAM operates.</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>CR3</code> is a control register that is used in virtual to physical address translation. Basically, during the context switch operation, the CR3 is populated with the address so as to locate the page table of the current process.</p>
</div>
<h4 id="tlb">TLB<a class="headerlink" href="#tlb" title="Permanent link">#</a></h4>
<p>Address translation is a costly process. Following the 4-level page table to resolve a virtual address to a physical address is called <em>page table walk</em>. This is done by the hardware so as to optimize the speed. Even then, in the worst case a single memory address may result into 4 extra memory accesses to fetch the PageMap, PGD, PMD and PTE. 
In some cases, it might be the case that the page has been swapped out to the disk due to high memory pressure. In that case, the page table will have the <code>invalid</code> flag set for that particular page. In this case, the hardware will generate a page-fault and the control is given to the OS. The OS will bring the page into the memory (may be by an eviction), set the page table entry as valid, and give the control to the hardware. </p>
<p>To optimize this process, the hardware maintains a small cache of the recently translated addresses in a structure called the TLB or <em>translational lookaside buffer</em>. It leverage the spatial and the temporal locality of an application.</p>
<p><img alt="large_drawing" src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/be/Page_table_actions.svg/880px-Page_table_actions.svg.png" />
<strong>Translation look aside buffer working. Source: Wikipedia.</strong></p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p><em>Spatial locality</em>: If you access a particular address, then you are likely to access the nearby addresses also.<br />
<em>Temporal locality</em>: If you access an address, then it is likely that you will access the same address again in the near future.</p>
</div>
<h4 id="huge-page">Huge page<a class="headerlink" href="#huge-page" title="Permanent link">#</a></h4>
<p>As the size of the memory is increasing, the reach of the TLB is getting smaller. This causes a large TLB miss in a modern application with large memory footprint. To solve this issue, modern architecture supports pages of different sizes. X86 supports page size of 4KB, 2MB, and 1GB.</p>
<p>This comes from this:</p>
<ol>
<li>Page offset: 12 bits i.e. <span><span class="MathJax_Preview">2^{12} = 4KB</span><script type="math/tex">2^{12} = 4KB</script></span></li>
<li>Page table offset 9 bits. Combine this with the previous 12 bits = <span><span class="MathJax_Preview">2^{21} = 2MB</span><script type="math/tex">2^{21} = 2MB</script></span>.</li>
<li>PMD offset 9 bits. Combine this with the previous 21 bits = <span><span class="MathJax_Preview">2^{30} = 1GB</span><script type="math/tex">2^{30} = 1GB</script></span> </li>
</ol>
<p>Other architectures support pages of different sizes based on their design. Interested readers can read the <a href="https://www.cse.iitd.ernet.in/~sbansal/pubs/hawkeye.pdf">Haweye paper</a> to know more about the huge page.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href=".." title="Home" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Home
              </div>
            </div>
          </a>
        
        
          <a href="../badgertrap/badgertrap/" title="Badger Trap" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Badger Trap
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.22b62ea4.min.js"></script>
      <script src="../assets/javascripts/bundle.5f27aba8.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.f6ebf1dc.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>